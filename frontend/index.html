<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pharmacy Assistant</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        background: #2563eb;
        color: white;
        padding: 1rem;
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
      }
      .container {
        flex: 1;
        display: flex;
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        overflow: hidden;
      }
      .chat-panel {
        flex: 2;
        display: flex;
        flex-direction: column;
        background: white;
        border-right: 1px solid #e0e0e0;
      }
      .tools-panel {
        flex: 1;
        background: #fafafa;
        overflow-y: auto;
        padding: 1rem;
      }
      .tools-panel h3 {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }
      .msg {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        max-width: 80%;
        line-height: 1.5;
      }
      .msg.user {
        background: #2563eb;
        color: white;
        margin-left: auto;
      }
      .msg.assistant {
        background: #e5e7eb;
        color: #1f2937;
      }
      .msg.rtl {
        direction: rtl;
        text-align: right;
      }
      .input-area {
        display: flex;
        padding: 1rem;
        border-top: 1px solid #e0e0e0;
        gap: 0.5rem;
      }
      #input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1rem;
      }
      #input:focus {
        outline: none;
        border-color: #2563eb;
      }
      button {
        padding: 0.75rem 1.5rem;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
      }
      button:hover {
        background: #1d4ed8;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .tool-call {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-bottom: 0.75rem;
        font-size: 0.85rem;
      }
      .tool-header {
        background: #f3f4f6;
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        color: #4b5563;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
      }
      .tool-body {
        padding: 0.75rem;
        display: none;
      }
      .tool-body.open {
        display: block;
      }
      .tool-section {
        margin-bottom: 0.5rem;
      }
      .tool-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.75rem;
        text-transform: uppercase;
      }
      .tool-content {
        background: #f9fafb;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .typing::after {
        content: "‚ñã";
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <header>üè• Pharmacy Assistant / ◊¢◊ï◊ñ◊® ◊ë◊ô◊™ ◊û◊®◊ß◊ó◊™</header>
    <div class="container">
      <div class="chat-panel">
        <div class="messages" id="messages"></div>
        <div class="input-area">
          <input
            type="text"
            id="input"
            placeholder="Ask about medications... / ◊©◊ê◊ú ◊¢◊ú ◊™◊®◊ï◊§◊ï◊™..."
            autofocus
          />
          <button id="send">Send</button>
        </div>
      </div>
      <div class="tools-panel">
        <h3>Tool Calls</h3>
        <div id="tools"></div>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById("messages");
      const toolsEl = document.getElementById("tools");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");

      // Conversation history (client-side ‚Äî stateless server)
      let history = [];

      // Detect Hebrew for RTL
      function isHebrew(text) {
        return /[\u0590-\u05FF]/.test(text);
      }

      // Add message to UI
      function addMessage(role, content) {
        const div = document.createElement("div");
        div.className = `msg ${role}`;
        if (isHebrew(content)) div.classList.add("rtl");
        div.textContent = content;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return div;
      }

      // Add tool call to panel
      function addToolCall(name, input, output) {
        const div = document.createElement("div");
        div.className = "tool-call";
        div.innerHTML = `
                <div class="tool-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    üîß ${name}
                </div>
                <div class="tool-body">
                    <div class="tool-section">
                        <div class="tool-label">Input</div>
                        <div class="tool-content">${JSON.stringify(
                          input,
                          null,
                          2
                        )}</div>
                    </div>
                    <div class="tool-section">
                        <div class="tool-label">Output</div>
                        <div class="tool-content">${JSON.stringify(
                          output,
                          null,
                          2
                        )}</div>
                    </div>
                </div>
            `;
        toolsEl.insertBefore(div, toolsEl.firstChild);
        // Auto-expand latest
        div.querySelector(".tool-body").classList.add("open");
      }

      // Send message
      async function send() {
        const text = inputEl.value.trim();
        if (!text) return;

        inputEl.value = "";
        sendBtn.disabled = true;

        // Add user message
        addMessage("user", text);
        history.push({ role: "user", content: text });

        // Create assistant message placeholder
        const assistantDiv = addMessage("assistant", "");
        assistantDiv.classList.add("typing");
        let assistantContent = "";

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: history }),
          });

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // Keep incomplete line

            for (const line of lines) {
              if (!line.startsWith("data: ")) continue;
              const data = JSON.parse(line.slice(6));

              if (data.type === "token") {
                assistantContent += data.content;
                assistantDiv.textContent = assistantContent;
                if (isHebrew(assistantContent)) {
                  assistantDiv.classList.add("rtl");
                }
                messagesEl.scrollTop = messagesEl.scrollHeight;
              } else if (data.type === "tool_call") {
                addToolCall(data.name, data.input, data.output);
              } else if (data.type === "done") {
                // Stream complete
              }
            }
          }

          assistantDiv.classList.remove("typing");
          if (assistantContent) {
            history.push({ role: "assistant", content: assistantContent });
          }
        } catch (err) {
          assistantDiv.textContent = "Error: " + err.message;
          assistantDiv.classList.remove("typing");
        }

        sendBtn.disabled = false;
        inputEl.focus();
      }

      sendBtn.addEventListener("click", send);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });
    </script>
  </body>
</html>
